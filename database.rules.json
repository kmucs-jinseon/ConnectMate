{
  "rules": {
    "users": {
      "$uid": {
        // Users can read any user's basic profile data (needed for friends list, activity participants, etc.)
        ".read": "auth != null",
        // Users can only write their own data
        ".write": "$uid === auth.uid",
        // Validate user data structure (allow deletion when newData doesn't exist)
        ".validate": "!newData.exists() || (newData.hasChildren(['email', 'displayName']) && newData.child('email').isString() && newData.child('displayName').isString())"
      }
    },

    "activities": {
      // Anyone authenticated can read all activities
      ".read": "auth != null",

      "$activityId": {
        // Authenticated users can create, update, or delete activities
        ".write": "auth != null"
      }
    },

    "userActivities": {
      "$userId": {
        // Users can read their own activities
        ".read": "$userId === auth.uid",

        "$activityId": {
          // Users can manage their own activity list
          ".write": "$userId === auth.uid"
        }
      }
    },

    "activityChatRooms": {
      // Mapping of activityId -> chatRoomId (public for finding chat rooms by activity)
      "$activityId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },

    "chatRooms": {
      "$chatRoomId": {
        // Allow reading if: user is authenticated
        ".read": "auth != null",

        // Allow writing if: user is authenticated (for creating, updating, deleting)
        ".write": "auth != null"
      }
    },

    "userChatRooms": {
      "$userId": {
        // Users can only read their own chat room list
        ".read": "$userId === auth.uid",

        // Allow writes at the userId level for multi-path updates
        ".write": "$userId === auth.uid"
      }
    },

    "messages": {
      "$chatRoomId": {
        // Allow reading if: user is authenticated
        ".read": "auth != null",

        // Allow writing if: user is authenticated (for sending and deleting)
        ".write": "auth != null"
      }
    }
  }
}
