{
  "rules": {
    "users": {
      "$uid": {
        // Users can read their own data
        ".read": "$uid === auth.uid",
        // Users can write their own data
        ".write": "$uid === auth.uid",
        // Validate user data structure (allow deletion when newData doesn't exist)
        ".validate": "!newData.exists() || (newData.hasChildren(['email', 'displayName']) && newData.child('email').isString() && newData.child('displayName').isString())"
      }
    },

    "activities": {
      // Anyone authenticated can read all activities
      ".read": "auth != null",

      "$activityId": {
        // Only authenticated users can create activities
        ".write": "auth != null && (!data.exists() || data.child('creatorId').val() === auth.uid)",

        // Validate activity data structure (allow deletion when newData doesn't exist)
        ".validate": "!newData.exists() || (newData.hasChildren(['id', 'title', 'creatorId', 'createdTimestamp']) && newData.child('id').isString() && newData.child('title').isString() && newData.child('creatorId').isString() && newData.child('createdTimestamp').isNumber())",

        "participants": {
          // Anyone can read participants
          ".read": "auth != null",

          "$userId": {
            // Users can add/remove themselves, or creator can manage participants
            ".write": "auth != null && ($userId === auth.uid || root.child('activities').child($activityId).child('creatorId').val() === auth.uid)"
          }
        },

        "currentParticipants": {
          // Automatically managed by server
          ".validate": "newData.isNumber()"
        }
      }
    },

    "userActivities": {
      "$userId": {
        // Users can read their own activities
        ".read": "$userId === auth.uid",

        "$activityId": {
          // Users can manage their own activity list
          ".write": "$userId === auth.uid"
        }
      }
    },

    "chatRooms": {
      "$chatRoomId": {
        // Only chat room members can read chat room data
        ".read": "auth != null && data.child('members').child(auth.uid).exists()",

        // Authenticated users can create chat rooms, or existing members can update
        ".write": "auth != null && (!data.exists() || data.child('members').child(auth.uid).exists())",

        // Validate chat room data structure (allow deletion when newData doesn't exist)
        ".validate": "!newData.exists() || (newData.hasChildren(['id', 'name', 'createdTimestamp']) && newData.child('id').isString() && newData.child('name').isString() && newData.child('createdTimestamp').isNumber())",

        "members": {
          "$userId": {
            // Users can add themselves, or existing members can add others
            ".write": "auth != null && ($userId === auth.uid || data.parent().child(auth.uid).exists())"
          }
        }
      }
    },

    "userChatRooms": {
      "$userId": {
        // Users can only read their own chat room list
        ".read": "$userId === auth.uid",

        "$chatRoomId": {
          // Users can manage their own chat room list
          ".write": "$userId === auth.uid"
        }
      }
    },

    "messages": {
      "$chatRoomId": {
        // Only chat room members can read messages
        ".read": "auth != null && root.child('chatRooms').child($chatRoomId).child('members').child(auth.uid).exists()",

        "$messageId": {
          // Only chat room members can send messages
          ".write": "auth != null && root.child('chatRooms').child($chatRoomId).child('members').child(auth.uid).exists()",

          // Validate message data structure (allow deletion when newData doesn't exist)
          ".validate": "!newData.exists() || (newData.hasChildren(['id', 'chatRoomId', 'senderId', 'message', 'timestamp']) && newData.child('id').isString() && newData.child('chatRoomId').isString() && newData.child('senderId').isString() && newData.child('message').isString() && newData.child('timestamp').isNumber())"
        }
      }
    }
  }
}
