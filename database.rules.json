{
  "rules": {
    "users": {
      "$uid": {
        // Users can read any user's basic profile data (needed for friends list, activity participants, etc.)
        ".read": "auth != null",
        // Users can only write their own basic data
        ".write": "$uid === auth.uid",
        // Validate user data structure (allow deletion when newData doesn't exist)
        ".validate": "!newData.exists() || (newData.hasChildren(['email', 'displayName']) && newData.child('email').isString() && newData.child('displayName').isString())",

        // Reviews - anyone can write reviews for any user
        "reviews": {
          "$reviewId": {
            ".write": "auth != null"
          }
        },

        // Friend requests - anyone can send friend requests
        "friendRequests": {
          "$requesterId": {
            ".write": "auth != null"
          }
        },

        // Friends list - anyone can add/remove friends (for reciprocal relationships)
        "friends": {
          "$friendId": {
            ".write": "auth != null"
          }
        },

        // Rating stats - anyone can update (for transactions during reviews)
        "ratingSum": {
          ".write": "auth != null"
        },
        "reviewCount": {
          ".write": "auth != null"
        },
        "rating": {
          ".write": "auth != null"
        },

        // Participation count - anyone can update (for transactions during activities)
        "participationCount": {
          ".write": "auth != null"
        }
      }
    },

    "activities": {
      // Anyone authenticated can read all activities
      ".read": "auth != null",

      "$activityId": {
        // Authenticated users can create, update, or delete activities
        ".write": "auth != null"
      }
    },

    "userActivities": {
      "$userId": {
        // Users can read their own activities
        ".read": "$userId === auth.uid",

        "$activityId": {
          // Users can manage their own activity list
          ".write": "$userId === auth.uid"
        }
      }
    },

    "activityChatRooms": {
      // Mapping of activityId -> chatRoomId (public for finding chat rooms by activity)
      "$activityId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },

    "chatRooms": {
      "$chatRoomId": {
        // Allow reading if: user is authenticated
        ".read": "auth != null",

        // Allow writing if: user is authenticated (for creating, updating, deleting)
        ".write": "auth != null"
      }
    },

    "userChatRooms": {
      "$userId": {
        // Users can only read their own chat room list
        ".read": "$userId === auth.uid",

        // Allow writes at the userId level for multi-path updates
        ".write": "$userId === auth.uid"
      }
    },

    "messages": {
      "$chatRoomId": {
        // Allow reading if: user is authenticated
        ".read": "auth != null",

        // Allow writing if: user is authenticated (for sending and deleting)
        ".write": "auth != null"
      }
    },

    "userNotifications": {
      "$userId": {
        // Users can read their own notifications
        ".read": "$userId === auth.uid",

        "$notificationId": {
          // Users can manage their own notifications (mark read/delete)
          // Other users can write (send notifications)
          ".write": "auth != null"
        }
      }
    },

    "userTokens": {
      "$userId": {
        // Users can read and write their own FCM token
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid"
      }
    },

    "pendingReviews": {
      "$userId": {
        // Users can read their own pending reviews
        ".read": "$userId === auth.uid",

        "$reviewId": {
          // Users can manage their own pending reviews
          ".write": "$userId === auth.uid"
        }
      }
    },

    "friendships": {
      "$userId": {
        // Users can read their own friendships
        ".read": "$userId === auth.uid",

        "$friendId": {
          // Users can manage their own friendships
          ".write": "$userId === auth.uid || $friendId === auth.uid"
        }
      }
    }
  }
}
